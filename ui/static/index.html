<!--
static/index.html - Minimal local-only chat UI

Notes:
- Sends POST /chat with X-API-Key header
- For streaming, this page uses non-streaming mode for simplicity
- Keep server bound to localhost and protect with API key
-->
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Vega2.0 Chat</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 2rem auto;
        }

        #log {
            border: 1px solid #ccc;
            padding: 1rem;
            height: 400px;
            overflow-y: auto;
        }

        .user {
            color: #0a58ca;
        }

        .bot {
            color: #198754;
        }
    </style>
</head>

<body>
    <h1>Vega2.0 Chat</h1>
    <div id="status"
        style="padding:8px;margin-bottom:8px;display:none;background:#fff3cd;color:#664d03;border:1px solid #ffe69c;">
        Degraded mode: LLM backend unavailable. Responses may be delayed or generic.
    </div>
    <div>
        <label>API Key <input id="key" type="password" placeholder="X-API-Key" /></label>
        <label style="margin-left:1rem;"><input id="stream" type="checkbox" /> Stream</label>
        <span id="session" style="margin-left:1rem;color:#666;font-size:0.9em;"></span>
    </div>
    <div id="log"></div>
    <div style="margin-top:1rem;">
        <input id="prompt" placeholder="Say something" style="width:70%" />
        <button id="send">Send</button>
    </div>

    <hr />
    <h2>Search</h2>
    <div>
        <input id="q" placeholder="Search the web" style="width:70%" />
        <button id="searchWeb">Web</button>
        <button id="searchImg">Images</button>
        <button id="research">Summarize</button>
    </div>
    <div id="results" style="margin-top:1rem;"></div>

    <hr />
    <h2>Username Search</h2>
    <div>
        <input id="uname" placeholder="username" style="width:40%" />
        <label style="margin-left:8px;"><input id="unameNSFW" type="checkbox" /> include NSFW</label>
        <input id="unameSites" placeholder="sites (comma-separated, optional)" style="width:40%;margin-left:8px;" />
        <button id="unameBtn" style="margin-left:8px;">Check</button>
    </div>
    <div id="unameResults" style="margin-top:0.5rem;"></div>

    <hr />
    <h2>Generation Settings</h2>
    <div id="gen">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
            <label>temperature <input id="gen_temperature" type="number" step="0.01" style="width:6rem" /></label>
            <label>top_p <input id="gen_top_p" type="number" step="0.01" style="width:6rem" /></label>
            <label>top_k <input id="gen_top_k" type="number" step="1" style="width:6rem" /></label>
            <label>repeat_penalty <input id="gen_repeat_penalty" type="number" step="0.01" style="width:7rem" /></label>
            <label>presence_penalty <input id="gen_presence_penalty" type="number" step="0.01"
                    style="width:7rem" /></label>
            <label>frequency_penalty <input id="gen_frequency_penalty" type="number" step="0.01"
                    style="width:7rem" /></label>
            <label><input id="gen_dynamic" type="checkbox" /> dynamic</label>
            <button id="genSave">Save</button>
            <button id="genReset">Reset</button>
            <span id="genMsg" style="color:#666;margin-left:8px;"></span>
        </div>
    </div>

    <script>
        const log = document.getElementById('log');
        const promptInput = document.getElementById('prompt');
        const keyInput = document.getElementById('key');
        const streamChk = document.getElementById('stream');
        const statusDiv = document.getElementById('status');
        const sessionSpan = document.getElementById('session');
        const sendBtn = document.getElementById('send');
        const qInput = document.getElementById('q');
        const searchWebBtn = document.getElementById('searchWeb');
        const searchImgBtn = document.getElementById('searchImg');
        const researchBtn = document.getElementById('research');
        const resultsDiv = document.getElementById('results');
        const genTemperature = document.getElementById('gen_temperature');
        const genTopP = document.getElementById('gen_top_p');
        const genTopK = document.getElementById('gen_top_k');
        const genRepeatPenalty = document.getElementById('gen_repeat_penalty');
        const genPresencePenalty = document.getElementById('gen_presence_penalty');
        const genFrequencyPenalty = document.getElementById('gen_frequency_penalty');
        const genDynamic = document.getElementById('gen_dynamic');
        const genSaveBtn = document.getElementById('genSave');
        const genResetBtn = document.getElementById('genReset');
        const genMsg = document.getElementById('genMsg');
        const unameInput = document.getElementById('uname');
        const unameNSFW = document.getElementById('unameNSFW');
        const unameSites = document.getElementById('unameSites');
        const unameBtn = document.getElementById('unameBtn');
        const unameResults = document.getElementById('unameResults');
        let sessionId = null;

        function addLine(text, cls) {
            const div = document.createElement('div');
            div.className = cls;
            div.textContent = text;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        async function send() {
            const prompt = promptInput.value.trim();
            const key = keyInput.value.trim();
            if (!prompt || !key) return;
            addLine('You: ' + prompt, 'user');
            promptInput.value = '';

            try {
                if (streamChk.checked) {
                    const resp = await fetch('/chat/sse', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': key,
                        },
                        body: JSON.stringify({ prompt: prompt, stream: true, session_id: sessionId })
                    });
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    const reader = resp.body.getReader();
                    const dec = new TextDecoder();
                    let buffer = '';
                    let botLine = '';
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buffer += dec.decode(value, { stream: true });
                        let idx;
                        while ((idx = buffer.indexOf('\n\n')) >= 0) {
                            const frame = buffer.slice(0, idx);
                            buffer = buffer.slice(idx + 2);
                            if (frame.startsWith('data: ')) {
                                const data = frame.slice(6);
                                botLine += data;
                                addLine('Vega: ' + botLine, 'bot');
                            }
                        }
                    }
                } else {
                    const resp = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': key,
                        },
                        body: JSON.stringify({ prompt: prompt, stream: false, session_id: sessionId })
                    });
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    const data = await resp.json();
                    if (data.session_id) {
                        sessionId = data.session_id;
                        sessionSpan.textContent = 'session: ' + sessionId;
                    }
                    addLine('Vega: ' + (data.response || ''), 'bot');
                }
            } catch (e) {
                addLine('Error: ' + e.message, 'bot');
            }
        }

        sendBtn.addEventListener('click', send);
        promptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') send(); });

        async function pollMetrics() {
            try {
                const r = await fetch('/metrics');
                if (!r.ok) throw new Error();
                const m = await r.json();
                if (m.degraded) {
                    statusDiv.style.display = 'block';
                } else {
                    statusDiv.style.display = 'none';
                }
            } catch { }
            setTimeout(pollMetrics, 5000);
        }
        pollMetrics();

        async function loadGen() {
            const key = keyInput.value.trim();
            if (!key) return;
            try {
                const r = await fetch('/admin/gen', { headers: { 'X-API-Key': key } });
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const s = await r.json();
                genTemperature.value = s.temperature ?? '';
                genTopP.value = s.top_p ?? '';
                genTopK.value = s.top_k ?? '';
                genRepeatPenalty.value = s.repeat_penalty ?? '';
                genPresencePenalty.value = s.presence_penalty ?? '';
                genFrequencyPenalty.value = s.frequency_penalty ?? '';
                genDynamic.checked = !!s.dynamic_generation;
                genMsg.textContent = 'loaded';
                setTimeout(() => genMsg.textContent = '', 1500);
            } catch (e) {
                genMsg.textContent = 'failed to load';
                setTimeout(() => genMsg.textContent = '', 2000);
            }
        }

        async function saveGen() {
            const key = keyInput.value.trim();
            if (!key) return;
            const body = {
                temperature: genTemperature.value === '' ? null : parseFloat(genTemperature.value),
                top_p: genTopP.value === '' ? null : parseFloat(genTopP.value),
                top_k: genTopK.value === '' ? null : parseInt(genTopK.value),
                repeat_penalty: genRepeatPenalty.value === '' ? null : parseFloat(genRepeatPenalty.value),
                presence_penalty: genPresencePenalty.value === '' ? null : parseFloat(genPresencePenalty.value),
                frequency_penalty: genFrequencyPenalty.value === '' ? null : parseFloat(genFrequencyPenalty.value),
                dynamic_generation: genDynamic.checked,
            };
            try {
                const r = await fetch('/admin/gen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': key },
                    body: JSON.stringify(body)
                });
                if (!r.ok) throw new Error('HTTP ' + r.status);
                genMsg.textContent = 'saved';
                setTimeout(() => genMsg.textContent = '', 1500);
            } catch (e) {
                genMsg.textContent = 'save failed';
                setTimeout(() => genMsg.textContent = '', 2000);
            }
        }

        async function resetGen() {
            const key = keyInput.value.trim();
            if (!key) return;
            try {
                const r = await fetch('/admin/gen/reset', { method: 'POST', headers: { 'X-API-Key': key } });
                if (!r.ok) throw new Error('HTTP ' + r.status);
                await loadGen();
                genMsg.textContent = 'reset';
                setTimeout(() => genMsg.textContent = '', 1500);
            } catch (e) {
                genMsg.textContent = 'reset failed';
                setTimeout(() => genMsg.textContent = '', 2000);
            }
        }

        genSaveBtn.addEventListener('click', saveGen);
        genResetBtn.addEventListener('click', resetGen);
        keyInput.addEventListener('change', loadGen);

        function renderResults(items) {
            resultsDiv.innerHTML = '';
            if (!items || items.length === 0) {
                resultsDiv.textContent = 'No results';
                return;
            }
            const ul = document.createElement('ul');
            for (const it of items) {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = it.href || it.url || it.image || '#';
                a.textContent = it.title || it.url || it.image || 'result';
                a.target = '_blank';
                li.appendChild(a);
                if (it.thumbnail) {
                    const img = document.createElement('img');
                    img.src = it.thumbnail;
                    img.style.maxHeight = '64px';
                    img.style.marginLeft = '8px';
                    li.appendChild(img);
                }
                if (it.snippet) {
                    const p = document.createElement('div');
                    p.textContent = it.snippet;
                    li.appendChild(p);
                }
                ul.appendChild(li);
            }
            resultsDiv.appendChild(ul);
        }

        async function doSearch(kind) {
            const key = keyInput.value.trim();
            const q = qInput.value.trim();
            if (!key || !q) return;
            const path = kind === 'web' ? '/search/web' : '/search/images';
            const resp = await fetch(path, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': key,
                },
                body: JSON.stringify({ query: q, max_results: 5, safesearch: 'moderate' })
            });
            if (!resp.ok) {
                resultsDiv.textContent = 'Error: HTTP ' + resp.status;
                return;
            }
            const data = await resp.json();
            renderResults(data.items || []);
        }

        async function doResearch() {
            const key = keyInput.value.trim();
            const q = qInput.value.trim();
            if (!key || !q) return;
            const resp = await fetch('/research/summarize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': key,
                },
                body: JSON.stringify({ query: q, max_results: 5, safesearch: 'moderate' })
            });
            if (!resp.ok) {
                resultsDiv.textContent = 'Error: HTTP ' + resp.status;
                return;
            }
            const data = await resp.json();
            renderResults(data.items || []);
            if (data.summary) {
                addLine('Summary: ' + data.summary, 'bot');
            }
        }

        searchWebBtn.addEventListener('click', () => doSearch('web'));
        searchImgBtn.addEventListener('click', () => doSearch('images'));
        researchBtn.addEventListener('click', () => doResearch());

        async function doUsernameSearch() {
            const key = keyInput.value.trim();
            const u = unameInput.value.trim();
            if (!key || !u) return;
            const siteStr = unameSites.value.trim();
            let sites = null;
            if (siteStr) {
                sites = siteStr.split(',').map(s => s.trim()).filter(Boolean);
            }
            unameResults.textContent = 'Checking...';
            const resp = await fetch('/osint/username', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-API-Key': key },
                body: JSON.stringify({ username: u, include_nsfw: unameNSFW.checked, sites })
            });
            if (!resp.ok) {
                unameResults.textContent = 'Error: HTTP ' + resp.status;
                return;
            }
            const data = await resp.json();
            const items = data.items || [];
            if (!items.length) { unameResults.textContent = 'No results'; return; }
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            const header = document.createElement('tr');
            for (const h of ['site', 'exists', 'status', 'url']) {
                const th = document.createElement('th');
                th.textContent = h;
                th.style.borderBottom = '1px solid #ccc';
                th.style.textAlign = 'left';
                header.appendChild(th);
            }
            table.appendChild(header);
            for (const it of items) {
                const tr = document.createElement('tr');
                const tdSite = document.createElement('td'); tdSite.textContent = it.site; tr.appendChild(tdSite);
                const tdEx = document.createElement('td'); tdEx.textContent = it.exists ? 'yes' : 'no'; tr.appendChild(tdEx);
                const tdSt = document.createElement('td'); tdSt.textContent = String(it.status); tr.appendChild(tdSt);
                const tdUrl = document.createElement('td'); const a = document.createElement('a'); a.href = it.url; a.textContent = it.url; a.target = '_blank'; tdUrl.appendChild(a); tr.appendChild(tdUrl);
                table.appendChild(tr);
            }
            unameResults.innerHTML = '';
            unameResults.appendChild(table);
        }
        unameBtn.addEventListener('click', doUsernameSearch);
    </script>
</body>

</html>